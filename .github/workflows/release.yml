name: Classifier Release
run-name: Build classifier
on: [push]
jobs:
  builds:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: 'x64'

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"
     
      - run: sudo apt-get update
      - run: python -m pip install --upgrade pip
      
      - run: pip install black --upgrade
      - run: ./check-style
        
      - name: Install dependencies
        run: |
          pip install cmake,freezegun, gdown
          sudo apt install -y python3-dbus ffmpeg build-essential libdbus-glib-1-dev libgirepository1.0-dev tzdata libcairo2-dev libjpeg-dev python3-cairo libhdf5-dev libopencv-dev cmake
          pip install -r requirements.txt
     

      - name: Run tests
        run: |
          pip install pytest
          pytest -s

      - name: Test Build
        run: python3 src/build.py -c tests/test-config.yaml tests --ext ".cptv"

      - name: Test Classify
        run: |
          sudo mkdir /var/spool/cptv
          sudo chmod -R 777 /var/spool/cptv
          wget -O thermal-model.tar https://github.com/TheCacophonyProject/AI-Model/releases/download/v0.5/inc3-19012023-tflite.tar
          mkdir thermal-model
          tar xzvf thermal-model.tar -C thermal-model --strip-components=1
          pip install tflite-runtime==2.14.0
          python3 src/classify.py -c tests/test-config.yaml ./tests/clips/
          python3 src/piclassify.py --file tests/clips/possum.cptv  --thermal-config-file tests/config.toml -c tests/test-config.yaml

