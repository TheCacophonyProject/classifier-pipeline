dist: bionic
language: python
python:
- '3.9'
install:
- sudo apt-get update
- sudo apt -y install ffmpeg
- sudo apt-get -y install libgirepository1.0-dev python3-dbus
- python -m pip install --upgrade pip
- sudo apt install -y build-essential libdbus-glib-1-dev libgirepository1.0-dev
- pip install -r requirements.txt
before_script:
- pip install black --upgrade
- pip install gdown
script:
- pytest -s
- "./check-style"
- python3 load.py -r -c tests/test-config.yaml
- python3 build.py -c tests/test-config.yaml
- python3 motiontest.py --thermal-config-file tests/config.toml -c tests/test-config.yaml
  tests/clips/possum.cptv
- sudo mkdir /var/spool/cptv
- sudo chmod -R 777 /var/spool/cptv
- |
  python -c "import gdown
  gdown.download(\"https://drive.google.com/u/1/uc?id=1CQoQLYbfX9NzRo2_BlpNE_I3c0iG6ZFd\", \"model_hq.tar\", quiet=False)"
- mkdir model
- tar -C model -xvf model_hq.tar
- cp model/val_acc/metadata.txt model/val_acc/saved_model.txt
- python3 classify.py -c tests/test-config.yaml ./tests/clips/
- python3 piclassify.py --file tests/clips/possum.cptv  --thermal-config-file tests/config.toml
  -c tests/test-config.yaml
before_deploy:
- pip install pex
- mkdir -p /tmp/x
- curl -sL https://github.com/goreleaser/nfpm/releases/download/v0.9.5/nfpm_0.9.5_Linux_x86_64.tar.gz
  | tar -C /tmp/x -xzf -
- PATH=/tmp/x:$PATH _release/build ${TRAVIS_TAG}
deploy:
  provider: releases
  api_key:
    secure: ewP4YaSO8hSzSXeazeOv/EZh9gsfhSjLnYIv7CS/GPo2dvwBi9e5fHYObPMKqy7zMuGbSr6tWmyAMs3jw/2Dzx3QqHHJXNR/2dXAcq/tTm9vdkCBBWzIeODifcgq5OUACE6KrbymRv5lq+pqEGmxGD2tn2192RI2TXzMU6DYqeRrF/ML8hTqbvC6GJ0RyZD0Mj5q4GwBaSZpdKilZZ23Rj1VJOmdSHBY0iw0aAetKiXQYzfmClBZYpBP7W5CUWbt1iLRiw7kqGIF1nPDLy2WgzIEVbFJdHmS7bqHFSSat7wtott5LmNKZICnsG/JC9L9zORCFiT+Hp4wVu83Y4bE1yqx4n5zO4rzP2sCLcP+gQfUcsX4VuA1WwpEyitQTWAQmdlcGWcWu5g18GwhpPXYmLGv0djWsauyShZ/qZ4qRs2VFV0LTuwWRfdFRuAm9wHkqGLmo3ihUZ+DkiAJ7ChITbKPk7YSbQb6T5o8+GLLg5j6nmyhP2bgQ0DKEZxfT/zm2heFasPirZZRU7eZLVNvW9tApn6hbjpyyswia4frH+LknbXb47xLfzBAbL8zN3FCAlO25O6FWmdYhH93uUxX8WsHx9yxT5QB6ku2nBLdFDa9rcIJfRnsrs2kkwSkNZjKP8U2IUQjueVdEBpDSZi5IeSUGBQuBCKxiENXWxgHZ+0=
  file_glob: true
  file: dist/*.deb
  on:
    repo: TheCacophonyProject/classifier-pipeline
    tags: true
  skip_cleanup: 'true'
